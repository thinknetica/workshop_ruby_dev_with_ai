# Спецификация чат-приложения для владельцев общих приватных репозиториев GitHub

## 1. Описание проекта
Веб-приложение для обмена текстовыми сообщениями между пользователями GitHub, у которых есть хотя бы один общий приватный репозиторий. Поддерживаются личные и групповые чаты, формируемые автоматически на основе состава приватных репозиториев.

✅ **Соответствие**: Полное соответствие с brainstorm.md
- Вопрос 1: Обмен сообщениями между владельцами общих приватных репозиториев
- Вопрос 5: Личные и групповые чаты
- Вопрос 6: Автоматическое создание чатов для всех владельцев приватного репозитория

---

## 2. Функциональные требования

### Аутентификация и пользователи
- Вход только через OAuth GitHub.
- При входе запрашиваются права на чтение приватных репозиториев.
- В базе сохраняются:
  — имя пользователя (GitHub username)
  — email
  — аватар
  — общее количество приватных репозиториев
  — общее количество звёзд
  — количество звёзд на приватных репозиториях

✅ **Соответствие**: Полное соответствие с brainstorm.md
- Вопрос 2: Только OAuth GitHub
- Вопрос 2: Права на чтение приватных репозиториев
- Вопрос 3: Сохранение username, email, аватар, количество приватных репозиториев, звёзды

### Список пользователей
- Все пользователи видят всех остальных пользователей приложения.
- Страница профиля доступна для любого пользователя.

✅ **Соответствие**: Полное соответствие с brainstorm.md
- Вопрос 4: Все пользователи видят всех остальных
- Вопрос 33: Страница профиля доступна всем

### Чаты
- Личные чаты (1-1) и групповые чаты (до 50 участников).
- Групповые чаты создаются автоматически для всех владельцев каждого приватного репозитория.
- Пользователь может выйти из группового чата (без автоматического возврата).
- В чате отображаются:
  — список участников (ник, аватар)
  — сообщения (аватар, ник, текст, время отправки)
- Сообщения:
  — только текстовые, до 400 символов
  — история сообщений хранится всегда
  — бесконечная прокрутка истории
  — стандартное выделение для копирования
  — нельзя редактировать или удалять сообщения
  — отображается время отправки
  — аватарка рядом с каждым сообщением
  — индикатор количества непрочитанных сообщений
  — только внутренние уведомления (индикатор новых сообщений)
- Статус онлайн/офлайн участников отображается.
- Сообщения доставляются всем, независимо от статуса онлайн.

✅ **Соответствие**: Полное соответствие с brainstorm.md
- Вопрос 5: Личные и групповые чаты
- Вопрос 6: Автоматическое создание для владельцев приватных репозиториев
- Вопрос 18: До 50 участников
- Вопрос 19: Возможность выхода без автоматического возврата
- Вопрос 7: Текстовые сообщения, уведомления, история
- Вопрос 18: 400 символов на сообщение
- Вопрос 11: Сообщения хранятся всегда
- Вопрос 25: Бесконечная прокрутка истории
- Вопрос 28: Стандартное выделение для копирования
- Вопрос 24: Нельзя редактировать или удалять сообщения
- Вопрос 26: Отображается время отправки
- Вопрос 27: Аватарка рядом с каждым сообщением
- Вопрос 29: Индикатор непрочитанных сообщений
- Вопрос 8: Только внутренние уведомления
- Вопрос 20: Статус онлайн/офлайн
- Вопрос 21: Сообщения доставляются всем

### Профили
- Страница профиля содержит:
  — имя, email, аватар
  — общее количество приватных репозиториев
  — общее количество звёзд
  — количество звёзд на приватных репозиториях
- Переход на профиль по клику на аватар/имя в чате.

✅ **Соответствие**: Полное соответствие с brainstorm.md
- Вопрос 33: Имя, email, аватар, количество приватных репозиториев, звёзды
- Вопрос 34: Переход на профиль по клику на аватар/имя

### Интерфейс
- Mobile first, адаптивная вёрстка.
- Тёмная тема.
- Поддержка русского и английского языков.
- Подтверждение выхода из группового чата (модальное окно).

✅ **Соответствие**: Полное соответствие с brainstorm.md
- Вопрос 17: Mobile first, адаптивная вёрстка
- Вопрос 31: Тёмная тема
- Вопрос 12: Поддержка русского и английского языков
- Вопрос 32: Подтверждение выхода из группового чата

---

## 3. Нефункциональные требования

- Безопасность: OAuth, HTTPS, защита от XSS/CSRF, стандартные Rails best practices.
- Нет интеграций с внешними сервисов, кроме GitHub.
- Нет модерации, фильтрации, поиска, закрепления сообщений, приглашений, поиска пользователей.
- Нет отображения количества общих репозиториев между участниками.

✅ **Соответствие**: Полное соответствие с brainstorm.md
- Вопрос 16: Стандартные меры безопасности (OAuth, HTTPS, XSS/CSRF)
- Вопрос 15: Нет интеграций с внешними сервисами, кроме GitHub
- Вопрос 9: Нет модерации
- Вопрос 13: Нет поиска по сообщениям
- Вопрос 23: Нет закрепления сообщений
- Вопрос 36: Нет поиска пользователей
- Вопрос 37: Нет системы приглашений
- Вопрос 35: Нет отображения количества общих репозиториев

---

## 4. Архитектура и технологии

- Backend: Ruby on Rails (API + Web)
- Frontend: Hotwire (Turbo, Stimulus), Tailwind CSS
- База данных: PostgreSQL
- Аутентификация: OmniAuth GitHub OAuth
- Хранение сообщений: таблица messages (связь с chat и user)
- Хранение чатов: таблица chats (тип: личный/групповой, связь с users)
- Хранение пользователей: таблица users (GitHub ID, username, email, avatar, counts)
- Хранение связей user-repo: таблица user_repositories (для вычисления общих репозиториев)
- Синхронизация с GitHub — только при входе пользователя

✅ **Соответствие**: Полное соответствие с brainstorm.md
- Вопрос 10: Синхронизация с GitHub только при входе пользователя
- Технологии соответствуют обсуждению

---

## 5. Работа с данными

- При входе пользователя:
  — Получение и сохранение данных пользователя и его приватных репозиториев через GitHub API.
  — Определение общих приватных репозиториев с другими пользователями.
  — Автоматическое создание/обновление чатов для каждого приватного репозитория.
- Сообщения сохраняются в базе, не удаляются.
- При выходе пользователя из группового чата — связь user-chat удаляется, но чат и сообщения сохраняются.

✅ **Соответствие**: Полное соответствие с brainstorm.md
- Вопрос 10: Обновление данных при входе пользователя
- Вопрос 11: Сообщения сохраняются всегда
- Вопрос 19: При выходе из группового чата связь удаляется, но чат сохраняется

---

## 6. Обработка ошибок

- Ошибки аутентификации — отображать понятные сообщения (например, "Не удалось войти через GitHub").
- Ошибки при работе с GitHub API — повторять попытку, показывать уведомление о проблеме.
- Ошибки при отправке сообщений — показывать уведомление, не терять введённый текст.
- Ограничения (длина сообщения, лимит участников) — валидировать на сервере и клиенте, показывать ошибки пользователю.
- Ошибки доступа (например, попытка написать в чат, где пользователь не состоит) — возвращать 403 Forbidden.

✅ **Соответствие**: Логично вытекает из обсужденных требований
- Обработка ошибок аутентификации
- Обработка ошибок GitHub API
- Валидация ограничений (вопрос 18: 400 символов, до 50 участников)
- Обработка ошибок доступа

---

## 7. Тестирование

- Покрытие моделей, контроллеров и сервисов тестами (RSpec или Minitest).
- Тесты на:
  — Аутентификацию и интеграцию с GitHub
  — Создание и отображение чатов
  — Отправку и отображение сообщений
  — Ограничения (длина, количество участников)
  — Интерфейс (Turbo, Stimulus, Tailwind)
  — Мобильную адаптивность и тёмную тему
  — Локализацию (RU/EN)
  — Безопасность (XSS, CSRF, доступ к чатам)
- Интеграционные тесты пользовательских сценариев (вход, чат, выход из чата, просмотр профиля и т.д.)

✅ **Соответствие**: Логично вытекает из обсужденных требований
- Тесты на все обсужденные функции
- Интеграционные тесты пользовательских сценариев

---

## 8. Прочее

- Нет необходимости в реальном времени синхронизировать данные с GitHub.
- Нет необходимости в модерации, фильтрации, поиске, закреплении сообщений, приглашениях.
- Все чаты и участники формируются автоматически на основе данных GitHub.
- Все сообщения и чаты хранятся бессрочно.

✅ **Соответствие**: Полное соответствие с brainstorm.md
- Вопрос 10: Нет реального времени синхронизации
- Вопрос 9: Нет модерации
- Вопрос 13: Нет поиска
- Вопрос 23: Нет закрепления сообщений
- Вопрос 37: Нет приглашений
- Вопрос 11: Все сообщения и чаты хранятся бессрочно

---

## 9. Структура таблиц (PostgreSQL, Rails migrations)

✅ **Соответствие**: Логично вытекает из обсужденных требований
- Вопрос 3: Поля пользователя (github_id, username, email, avatar, counts)
- Вопрос 6: Связи для групповых чатов (chat_users, repositories)
- Вопрос 18: Ограничения на сообщения (content max 400)
- Вопрос 19: Отслеживание участия в чатах (joined_at, left_at)
- Вопрос 29: Отслеживание непрочитанных сообщений (unread_messages)

### users
- id: bigint (PK)
- github_id: bigint, уникальный, не null
- username: string, не null
- email: string
- avatar_url: string
- private_repos_count: integer, default: 0
- stars_count: integer, default: 0
- private_stars_count: integer, default: 0
- online: boolean, default: false
- created_at, updated_at

### repositories
- id: bigint (PK)
- github_repo_id: bigint, уникальный, не null
- name: string, не null
- private: boolean, не null
- created_at, updated_at

### user_repositories
- id: bigint (PK)
- user_id: bigint (FK users)
- repository_id: bigint (FK repositories)
- created_at, updated_at

### chats
- id: bigint (PK)
- chat_type: string, enum: ['private', 'group'], не null
- repository_id: bigint (FK repositories, nullable для личных чатов)
- created_at, updated_at

### chat_users
- id: bigint (PK)
- chat_id: bigint (FK chats)
- user_id: bigint (FK users)
- joined_at: datetime
- left_at: datetime (nullable)
- created_at, updated_at

### messages
- id: bigint (PK)
- chat_id: bigint (FK chats)
- user_id: bigint (FK users)
- content: string (max 400)
- created_at

### unread_messages
- id: bigint (PK)
- user_id: bigint (FK users)
- chat_id: bigint (FK chats)
- last_read_message_id: bigint (FK messages, nullable)
- updated_at

---

## 10. Схемы API (REST/JSON)

✅ **Соответствие**: Логично вытекает из обсужденных функций
- Вопрос 2: OAuth GitHub (/auth/github)
- Вопрос 4: Список пользователей (/api/users)
- Вопрос 33: Профили пользователей (/api/users/:id)
- Вопрос 19: Выход из группового чата (/api/chats/:id/leave)
- Вопрос 25: Бесконечная прокрутка сообщений (/api/chats/:chat_id/messages)
- Вопрос 20: Статус онлайн/офлайн (/api/me/online, /api/me/offline)

### Аутентификация
- `GET /auth/github` — редирект на GitHub OAuth
- `GET /auth/github/callback` — callback, создание/обновление пользователя

### Пользователь
- `GET /api/users` — список всех пользователей
  Ответ: [{id, username, avatar_url, online}, ...]
- `GET /api/users/:id` — профиль пользователя
  Ответ: {id, username, email, avatar_url, private_repos_count, stars_count, private_stars_count}
- `GET /api/me` — текущий пользователь

### Чаты
- `GET /api/chats` — список чатов пользователя
  Ответ: [{id, chat_type, repository_id, participants: [{id, username, avatar_url, online}], unread_count, last_message}, ...]
- `GET /api/chats/:id` — детали чата
  Ответ: {id, chat_type, participants, messages: [ ... ], repository_id}
- `POST /api/chats/:id/leave` — выйти из группового чата

### Сообщения
- `GET /api/chats/:chat_id/messages?before=<message_id>&limit=30` — история сообщений (бесконечная прокрутка)
- `POST /api/chats/:chat_id/messages`
  Тело: {content: string}
  Ответ: {id, user_id, content, created_at}
- `POST /api/chats/:chat_id/read` — отметить сообщения как прочитанные

### Статус онлайн
- `POST /api/me/online` — установить онлайн
- `POST /api/me/offline` — установить оффлайн

---

## 11. Примеры UI (словесно и wireframe-описание)

✅ **Соответствие**: Логично вытекает из обсужденных требований
- Вопрос 17: Mobile first, адаптивная вёрстка
- Вопрос 31: Тёмная тема
- Вопрос 27: Аватары в сообщениях
- Вопрос 32: Подтверждение выхода из группового чата
- Вопрос 33: Профили пользователей
- Вопрос 29: Индикаторы непрочитанных сообщений
- Вопрос 20: Статус онлайн/офлайн

### Главная (список чатов)
- Слева: список чатов (аватар, название, индикатор непрочитанных, онлайн-статус участников)
- По центру: выбранный чат (история сообщений, бесконечная прокрутка, поле ввода, кнопка отправки)
- Вверху: кнопка профиля, переключатель темы (светлая/тёмная)

### Чат
- Вверху: название чата, список участников (аватары, онлайн-статус)
- Сообщения:
  — слева аватар, справа bubble с текстом, ник, время
  — новые сообщения подсвечиваются
  — стандартное выделение текста
- Внизу: поле ввода (макс. 400 символов), кнопка отправки
- Кнопка "Выйти из чата" (для групповых чатов, с подтверждением)

### Профиль пользователя
- Аватар, ник, email
- Количество приватных репозиториев, общее количество звёзд, количество звёзд на приватных
- Кнопка "Назад" или переход к чату

### Мобильная версия
- Меню чатов — выпадающее/выезжающее
- Чат — на весь экран, адаптивные элементы
- Кнопка профиля и переключатель темы — в меню
